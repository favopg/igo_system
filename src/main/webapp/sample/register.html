<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>対戦成績登録</title>
	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js"></script>
  	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.min.js"></script>
</head>
<style>
	.custom-alert {
		border-color: #0d6efd; /* 青枠 */
		color: #dc3545; /* 赤字 */
		background-color: #f8d7da; /* 薄い赤の背景 */
	}

	/** ローディング用スタイル */
	.loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
        
    .loading-content {
        background: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
    }
	/** ローディング用スタイル ここまで */

</style>

<body>
	<div id="app" class="container mt-5">
		<h1>対戦成績登録</h1>
		<div v-if="errors.message"  id="errorMessage" class="alert custom-alert" role="alert">
            {{ errors.message }}
        </div>

		<!-- モーダル -->
		<div class="modal fade" tabindex="-1" ref="myModal" id="exampleModal">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
				  		<h5 class="modal-title">登録完了</h5>
				  		<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
				  		<p>対戦成績が登録完了しました。</p>
						<p>対戦成績一覧画面に遷移します。</p>
					</div>
					<div class="modal-footer">
				  		<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">NO</button>
				  		<button type="button" @click="getTrantition" class="btn btn-primary">OK</button>
					</div>
			  	</div>
			</div>
		</div>

		<!-- ローディングオーバーレイ -->
        <div v-if="loading" class="loading-overlay">
            <div class="loading-content">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">登録中...</span>
                </div>
                <div class="mt-2">
                    対戦成績を登録中...
                </div>
                <div class="progress mt-2" style="width: 200px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         style="width: 100%">
                    </div>
                </div>
            </div>
        </div>

		<form @submit.prevent="validateForm" novalidate>
			<!-- 黒番 -->
			<div class="mb-3">
				<label for="blackPlayer" class="form-label">黒番</label>
				<input type="text" id="blackPlayer" class="form-control" v-model="input.blackPlayer" />
				<div v-if="errors.blackPlayer" class="text-danger mt-1">
					{{ errors.blackPlayer }}
				</div>
			</div>

			<!-- 白番 -->
			<div class="mb-3">
				<label for="whitePlayer" class="form-label">白番</label>
				<input type="text" id="whitePlayer" class="form-control" v-model="input.whitePlayer" />
				<div v-if="errors.whitePlayer" class="text-danger mt-1">
					{{ errors.whitePlayer }}
				</div>
			</div>

			<!-- 結果 -->
			<div class="mb-3">
				<label for="result" class="form-label">結果</label>
				<input type="text" id="result" class="form-control" v-model="input.result" />
				<div v-if="errors.result" class="text-danger mt-1">
					{{ errors.result }}
				</div>
			</div>

			<!-- 棋譜 -->
			<div class="mb-3">
				<label for="kifu" class="form-label">棋譜</label>
				<input type="text" id="kifu" class="form-control" v-model="input.kifu" />
				<div v-if="errors.kifu" class="text-danger mt-1">
					{{ errors.kifu }}
				</div>
			</div>

			<!-- 登録ボタン -->
			<button type="submit" class="btn btn-primary">登録</button>
		</form>
	</div>

	<!-- Vue & Script -->
	<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
	<script>
		const { createApp} = Vue;
		createApp({			
			setup() {
    			const openModal = () => {
					// モーダルを取得
					const modalElement = document.getElementById('exampleModal');
      				// Bootstrap の Modal クラスを初期化
      				const modal = new bootstrap.Modal(modalElement);
      				// モーダルを表示
      				modal.show();
    			};

    			return {
      				openModal,
    			};

				 // expose で関数を公開
				 expose({
					openModal
        		});
  			},
			data() {
				return {
					loading: false,
                    input: {
                        blackPlayer: "",
					    whitePlayer: "",
					    result: "",
					    kifu: ""
                    },
					errors: {
						blackPlayer: "",
						whitePlayer: "",
						result: "",
						kifu: "",
						message:""
					},
				};
			},
			methods: {
				getTrantition() {
					// 画面遷移する
					window.location.href = 'get_json_sample.html';
				},
				
				validateForm() {
					// リセット
					this.errors = {
						blackPlayer: "",
						whitePlayer: "",
						result: "",
						kifu: "",
						message:"",
					};

					// 黒番：全角20文字チェック
					if (!this.isFullWidth(this.input.blackPlayer) || this.input.blackPlayer.length > 20) {
						this.errors.blackPlayer = "黒番は全角20文字以内で入力してください。";
					}

					// 白番：全角20文字チェック
					if (!this.isFullWidth(this.input.whitePlayer) || this.input.whitePlayer.length > 20) {
						this.errors.whitePlayer = "白番は全角20文字以内で入力してください。";
					}

					// 結果：黒 or 白 かつ 勝 or 負を含むか
					if (!/(黒|白).*(勝|負)/.test(this.input.result)) {
						this.errors.result = "結果は「黒 or 白」と「勝 or 負」を含めて入力してください。";
					}

					// 棋譜：半角英数字記号チェック
					if (!/^[\x20-\x7E]+$/.test(this.input.kifu)) {
						this.errors.kifu = "棋譜は半角英数字および記号で入力してください。";
					}

					// ローディング表示
					this.loading = true;

					// ここに登録用ロジックを記載
					fetch('igo_system',{
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body:JSON.stringify(this.input)
                    })
						.then(response => {
							if (!response.ok) {
								throw new Error('HTTP error ' + response.status);
							}
							return response.json();
						})
						.then(data => {
                            if (data.status === 'success') {
                                // success の場合にモーダル画面を表示する
								this.openModal();
                            } else {
                                // errorの場合はエラーメッセージを表示する
								this.errors.message = data.message;
                            }
							// 処理完了後にローディング非表示
							this.loading = false;
						})
						.catch(error => {
							console.error('エラー:', error);
						});
						
				},
				// 全角チェック
				isFullWidth(input) {
					return /^[^\x00-\x7F]*$/.test(input);
				},
			},
		}).mount("#app");
		
	</script>
</body>

</html>