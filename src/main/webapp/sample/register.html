<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>入力フォームチェック</title>
	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>

<body>
	<div id="app" class="container mt-5">
		<h1>入力フォーム</h1>
		<h3></h3>

		<form @submit.prevent="validateForm" novalidate>
			<!-- 黒番 -->
			<div class="mb-3">
				<label for="blackPlayer" class="form-label">黒番</label>
				<input type="text" id="blackPlayer" class="form-control" v-model="input.blackPlayer" />
				<div v-if="errors.blackPlayer" class="text-danger mt-1">
					{{ errors.blackPlayer }}
				</div>
			</div>

			<!-- 白番 -->
			<div class="mb-3">
				<label for="whitePlayer" class="form-label">白番</label>
				<input type="text" id="whitePlayer" class="form-control" v-model="input.whitePlayer" />
				<div v-if="errors.whitePlayer" class="text-danger mt-1">
					{{ errors.whitePlayer }}
				</div>
			</div>

			<!-- 結果 -->
			<div class="mb-3">
				<label for="result" class="form-label">結果</label>
				<input type="text" id="result" class="form-control" v-model="input.result" />
				<div v-if="errors.result" class="text-danger mt-1">
					{{ errors.result }}
				</div>
			</div>

			<!-- 棋譜 -->
			<div class="mb-3">
				<label for="kifu" class="form-label">棋譜</label>
				<input type="text" id="kifu" class="form-control" v-model="input.kifu" />
				<div v-if="errors.kifu" class="text-danger mt-1">
					{{ errors.kifu }}
				</div>
			</div>

			<!-- 送信ボタン -->
			<button type="submit" class="btn btn-primary">送信</button>
		</form>
	</div>

	<!-- Vue & Script -->
	<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
	<script>
		const app = Vue.createApp({
			data() {
				return {
                    input: {
                        blackPlayer: "",
					    whitePlayer: "",
					    result: "",
					    kifu: ""
                    },
					errors: {
						blackPlayer: "",
						whitePlayer: "",
						result: "",
						kifu: "",
					},
				};
			},
			methods: {
				validateForm() {
					// リセット
					this.errors = {
						blackPlayer: "",
						whitePlayer: "",
						result: "",
						kifu: "",
					};

					// 黒番：全角20文字チェック
					if (!this.isFullWidth(this.input.blackPlayer) || this.input.blackPlayer.length > 20) {
						this.errors.blackPlayer = "黒番は全角20文字以内で入力してください。";
					}

					// 白番：全角20文字チェック
					if (!this.isFullWidth(this.input.whitePlayer) || this.input.whitePlayer.length > 20) {
						this.errors.whitePlayer = "白番は全角20文字以内で入力してください。";
					}

					// 結果：黒 or 白 かつ 勝 or 負を含むか
					if (!/(黒|白).*(勝|負)/.test(this.input.result)) {
						this.errors.result = "結果は「黒 or 白」と「勝 or 負」を含めて入力してください。";
					}

					// 棋譜：半角英数字記号チェック
					if (!/^[\x20-\x7E]+$/.test(this.input.kifu)) {
						this.errors.kifu = "棋譜は半角英数字および記号で入力してください。";
					}

					// エラーがなければ成功アラート
					if (Object.values(this.errors).every((error) => !error)) {
						//alert("送信成功！");
					}

					// ここに登録用ロジックを記載
					fetch('igo_system',{
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body:JSON.stringify(this.input)
                    })
						.then(response => {
							if (!response.ok) {
								throw new Error('HTTP error ' + response.status);
							}
							return response.json();
						})
						.then(data => {
                            if (data.status === 'success') {
                                // success の場合に画面遷移
                                window.location.href = 'get_json_sample.html'; // 遷移先URL
                            } else {
                                // errorの場合はエラーメッセージを表示する
                            }
						})
						.catch(error => {
							console.error('エラー:', error);
							//document.getElementById('result').textContent = 'エラーが発生しました';
						});
				},
				// 全角チェック
				isFullWidth(input) {
					return /^[^\x00-\x7F]*$/.test(input);
				},
			},
		});

		app.mount("#app");
	</script>
</body>

</html>